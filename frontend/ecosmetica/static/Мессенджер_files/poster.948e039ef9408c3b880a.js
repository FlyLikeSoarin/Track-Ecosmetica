!function(e){function t(t){for(var i,l,n=t[0],a=t[1],h=t[2],_=0,c=[];_<n.length;_++)l=n[_],Object.prototype.hasOwnProperty.call(r,l)&&r[l]&&c.push(r[l][0]),r[l]=0;for(i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i]);for(d&&d(t);c.length;)c.shift()();return o.push.apply(o,h||[]),s()}function s(){for(var e,t=0;t<o.length;t++){for(var s=o[t],i=!0,n=1;n<s.length;n++){var a=s[n];0!==r[a]&&(i=!1)}i&&(o.splice(t--,1),e=l(l.s=s[0]))}return e}var i={},r={"web/poster":0},o=[];function l(t){if(i[t])return i[t].exports;var s=i[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,l),s.l=!0,s.exports}l.m=e,l.c=i,l.d=function(e,t,s){l.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,t){if(1&t&&(e=l(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(l.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)l.d(s,i,function(t){return e[t]}.bind(null,i));return s},l.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(t,"a",t),t},l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.p="/js/cmodules/";var n=window.webpackJsonp=window.webpackJsonp||[],a=n.push.bind(n);n.push=t,n=n.slice();for(var h=0;h<n.length;h++)t(n[h]);var d=a;o.push([248,"vendors","common"]),s()}({248:function(e,t,s){e.exports=s("OL9c")},OL9c:function(e,t,s){"use strict";s.r(t);s("pIFo"),s("a1Th"),s("rGqo"),s("Btvt"),s("KKXr"),s("SRfc"),s("91GP");var i=s("zxIV"),r=s("Egk5"),o=s("v+DW"),l=s("4+be"),n=s("jE6c"),a=s("t7n3"),h=s("aong"),d=s("7jxN"),_=s("FWc3"),c=s("EasH");class p{constructor(e){this._onSubmitCallback=e.onSubmit,this._placeholderText=e.placeholder,this._initCallbacks(e)}show(){var e={oid:this._getPostOwnerId(),act:"upload_bkg_box"},t={containerClass:"poster-uploader",params:{hideButtons:!0,width:655,onDestroy:this._onLayerDestroy.bind(this)},onDone:this._onShowBoxDone.bind(this)};this.box=Object(c.showBox)("al_poster.php",e,t)}hide(){this.box.hide()}_init(e,t){e.isVisible()&&(this._initElements(e.bodyNode),this._initListeners(),this._initUpload(t),this._initDragAndDrop())}_initElements(e){this._els={},this._els.dropBox=geByClass1("poster-uploader__drop-box",e),this._els.dropArrowBtn=geByClass1("poster-uploader__arrow-btn",e),this._els.dropWrapper=geByClass1("poster-uploader__drop-area",e),this._els.editWrapper=geByClass1("poster-uploader__background-edit",e),this._els.closeBtn=ge("poster-uploader-close-btn"),this._els.uploadInput=ge("poster-uploader-file-input"),this._els.uploadMainInput=ge("poster-uploader-main-file-input"),this._els.status=ge("poster-uploader-status"),this._els.posterView=geByClass1("poster__image",e),this._els.posterTextEl=geByClass1("poster__text",e),this._els.overlay=geByClass1("poster-uploader__overlay",e),this._els.pickerItem=geByClass1("poster-color-ctrl__picker",e),this._els.pickerInput=ge("poster-color-picker"),this._els.pickerTextInput=ge("poster-color-input"),this._els.pickerTextInputWrapper=geByClass1("poster-color-ctrl__color-input-wrapper",e),this._els.gallery=geByClass1("poster-color-ctrl__gallery",e),this._els.saveBtn=geByClass1("poster-uploader__save",e),this._els.cancelBtn=geByClass1("poster-uploader__cancel",e),this._isColorPickerSupport()||(re(this._els.pickerItem),show(this._els.pickerTextInputWrapper)),this._swipeColorItem(this._els.gallery.firstElementChild),this._updateText()}_initListeners(){this._handlersForDestroy=[];var e=()=>{this.hide()},t=()=>{this._els.uploadInput.click()},s=this._submit.bind(this),i=e=>{var t=e.target.files;this._uploadToModel(t)},o=this._onColorItemClick.bind(this);if(Object(r.addEvent)(this._els.uploadInput,"change",i),Object(r.addEvent)(this._els.saveBtn,"click",s),Object(r.addEvent)(this._els.closeBtn,"click",e),Object(r.addEvent)(this._els.cancelBtn,"click",()=>{hide(this._els.editWrapper),show(this._els.dropWrapper),this._files=null,this._els.pickerInput.value="",this._els.pickerTextInput.value="",this._els.uploadInput.value=null,this._swipeColorItem(this._els.gallery.firstElementChild)}),Object(r.addEvent)(this._els.dropBox,"click",t),Object(r.addEvent)(this._els.dropArrowBtn,"click",t),Object(r.addEvent)(this._els.gallery,"click",o),this._handlersForDestroy.push(()=>{Object(r.removeEvent)(this._els.dropArrowBtn,"click",t),Object(r.removeEvent)(this._els.gallery,"click",o),Object(r.removeEvent)(this._els.uploadInput,"change",i),Object(r.removeEvent)(this._els.closeBtn,"click",e),Object(r.removeEvent)(this._els.dropBox,"click",t)}),this._isColorPickerSupport()){var l=()=>{this._swipeColorItem(this._els.pickerItem,this._els.pickerInput.value),this._els.pickerItem.style.backgroundColor=this._els.pickerInput.value},n=()=>{this._els.pickerInput.click()};Object(r.addEvent)(this._els.pickerInput,"input",l),Object(r.addEvent)(this._els.pickerItem,"click",n),this._handlersForDestroy.push(()=>{Object(r.removeEvent)(this._els.pickerInput,"input",l),Object(r.removeEvent)(this._els.pickerItem,"click",n)})}else{var a=e=>{if(!s(e)){var t=String.fromCharCode(e.keyCode);(s(e)||/^[a-f0-9]$/i.test(t))&&(this._els.pickerInput.focus(),document.execCommand("insertText",!1,t)),cancelEvent(e)}function s(e){return e.keyCode===KEY.DEL||e.keyCode===KEY.UP||e.keyCode===KEY.RIGHT||e.keyCode===KEY.LEFT||e.keyCode===KEY.DOWN||46===e.keyCode||e.ctrlKey||e.metaKey}},h=()=>{var e="#"+this._els.pickerTextInput.value.toUpperCase();/^#([0-9a-f]{3}){1,2}$/i.test(e)&&this._swipeColorItem(this._els.pickerTextInput,e),"#"===e&&this._swipeColorItem(this._els.pickerTextInput,"#fff")},d=e=>{var t=trim(e.clipboardData.getData("Text")).toUpperCase();"#"===t[0]&&(t=t.slice(1)),/^[a-f0-9]{1,6}$/i.test(t)&&document.execCommand("insertText",!1,t),cancelEvent(e)};Object(r.addEvent)(this._els.pickerTextInput,"paste",d),Object(r.addEvent)(this._els.pickerTextInput,"keydown",a),Object(r.addEvent)(this._els.pickerTextInput,"input",h),this._handlersForDestroy.push(()=>{Object(r.removeEvent)(this._els.pickerTextInput,"paste",d),Object(r.removeEvent)(this._els.pickerTextInput,"keydown",a),Object(r.removeEvent)(this._els.pickerTextInput,"input",h)})}}_initCallbacks(e){Object(n.isFunction)(e.onHide)&&(this._onHideCallback=e.onHide),Object(n.isFunction)(e.getExampleText)&&(this._getExampleText=e.getExampleText),Object(n.isFunction)(e.getPostOwnerId)?this._getPostOwnerId=e.getPostOwnerId:this._getPostOwnerId=()=>cur.oid}_updateColor(e){var t=Object(d.getRGB)(e);function s(e){var t=e.toString(16);return 1===t.length?"0"+t:t}this._textColor=function(e,t,i){return"#"+s(e)+s(t)+s(i)}(...t),this._els.posterTextEl.style.color=this._textColor,this._isColorPickerSupport()&&(this._els.pickerInput.value=this._textColor)}_initUpload(e){var t=this._getUploadParams(e);this._files=null,this._minImageSizesArr=e.min_image_sizes,this.uploadId=Upload.init(this._els.uploadMainInput,e.url,{},t)}_uploadToBackend(){Upload.onFileApiSend(this.uploadId,this._files)}_uploadToModel(e){if(e.length)if(e.length>1)Object(c.showFastBox)(getLang("global_error"),getLang("wall_poster_upload_wrong_number_image"));else if(this._isFileTypeValid(e[0].name)){var t=e[0],s=new FileReader,i=this;s.onload=function(){i._checkImageSizes(s.result,()=>{i._files=e,i._els.posterView.style.backgroundImage=`url("${s.result}")`,hide(i._els.dropWrapper),show(i._els.editWrapper)},()=>{Object(c.showFastBox)(getLang("global_error"),getLang("wall_poster_upload_wrong_image_size"))})},s.readAsDataURL(t)}else Object(c.showFastBox)(getLang("global_error"),getLang("wall_poster_upload_wrong_type_file"))}_checkImageSizes(e,t,s){var i=new Image,r=this;i.onload=function(){this.width<r._minImageSizesArr[0]||this.height<r._minImageSizesArr[1]?s():t()},i.src=e}_submit(){this._uploadToBackend()}_swipeColorItem(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.style.backgroundColor;removeClass(this._els.activeColorItem,"_active"),this._els.activeColorItem=e,addClass(e,"_active"),this._updateColor(t)}_isColorPickerSupport(){if(null!=this._pickerSupport)return this._pickerSupport;var e=document.createElement("input");return e.type="color",e.value="<!>",this._pickerSupport="color"===e.type&&"<!>"!==e.value}_onShowBoxDone(e,t){this._init(e,t)}_getUploadParams(e){return{file_name:"photo",file_size_limit:26214400,file_types:"*.jpg;*.JPG;*.jpeg;*.JPEG;*.png;*.PNG;",file_types_description:"Image files (*.jpg, *.jpeg, *.png)",clear:1,type:"photo",noFlash:1,max_attempts:3,signed:1,static_url:e.static_url,check_url:e.check_url,base_url:e.base_url,buttonClass:"poster-uploader__select-file",lang:e.lang,onUploadStart:this._onUploadStart.bind(this),onUploadComplete:this._onUploadComplete.bind(this)}}_onUploadStart(){this._lockUploader()}_onUploadComplete(e,t,s){var i=()=>{Object(c.showFastBox)(getLang("global_error"),getLang("wall_poster_upload_unknown_error")),this._unlockUploader()};try{var r=parseJSON(t);if(this._resultBkg={main_color:r.main_color},r&&r.error)return void i()}catch(e){return void i()}this._sendParams(t,e=>{this._resultBkg=e,this._onSubmitCallback(this._resultBkg),this._unlockUploader(),this.hide()},i)}_onColorItemClick(e){var t=e.target;hasClass(t,"poster-color-ctrl__gallery-item")&&t!==this._els.pickerItem&&(this._els.pickerItem.style.backgroundColor="",this._swipeColorItem(t))}_sendParams(e,t,s){ajax.post("al_poster.php",{act:"add_custom_bkg",_query:e,text_color:this._textColor.slice(1)},{onDone:t,onFail:s})}_updateText(){var e=this._getExampleText&&this._getExampleText();this._els.posterTextEl.innerHTML=e||this._placeholderText}_lockUploader(){Object(o.lockButton)(this._els.saveBtn),show(this._els.overlay)}_unlockUploader(){Object(o.unlockButton)(this._els.saveBtn),hide(this._els.overlay)}_initDragAndDrop(){var e=this._onDragEnter.bind(this),t=this._onDragLeave.bind(this),s=this._onDrop.bind(this);function i(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover","dragleave","drop"].forEach(e=>{this._els.dropBox.addEventListener(e,i)}),["dragenter","dragover"].forEach(t=>{Object(r.addEvent)(this._els.dropBox,t,e)}),["dragleave","drop"].forEach(e=>{Object(r.addEvent)(this._els.dropBox,e,t)}),Object(r.addEvent)(this._els.dropBox,"drop",s),this._handlersForDestroy.push(()=>{["dragenter","dragover","dragleave","drop"].forEach(e=>{this._els.dropBox.removeEventListener(e,i)}),["dragenter","dragover"].forEach(t=>{this._els.dropBox.removeEventListener(t,e)}),["dragleave","drop"].forEach(e=>{this._els.dropBox.removeEventListener(e,t)}),Object(r.removeEvent)(this._els.dropBox,"drop",s)})}_onDragEnter(e){this._dragAndDropTimeoutId&&(clearTimeout(this._dragAndDropTimeoutId),cancelEvent(e)),this._dragAndDropTimeoutId=setTimeout(()=>{addClass(this._els.dropBox,"dropbox_over")})}_onDragLeave(e){this._dragAndDropTimeoutId&&(clearTimeout(this._dragAndDropTimeoutId),cancelEvent(e)),this._dragAndDropTimeoutId=setTimeout(()=>{removeClass(this._els.dropBox,"dropbox_over")},100)}_onDrop(e){var t=e.dataTransfer.files;this._uploadToModel(t)}_onLayerDestroy(){this._onHideCallback(),this.destroy()}_isFileTypeValid(e){return!!e&&"*.jpg;*.JPG;*.jpeg;*.JPEG;*.png;*.PNG;".split(";").some(t=>(t=t.slice(1),e.substr(-t.length).toLowerCase()===t))}destroy(){for(var e=null,t=this._handlersForDestroy||[];e=t.pop();)e();Upload.deinit(this.uploadId)}}var g=class{constructor(e,t){this.state={disabled:!1,opened:!1,toggled:!1},this._flags={isFirstLaunch:!0},this._els={},this._backgroundsMap={},this._categoriesMap={},this._config={constants:e.constants,eventHash:e.events_hash,uploadGen:e.upload_gen,uploadBkgsEnabled:e.custom_enabled,customLayerPlaceholder:e.custom_layer_placeholder},this._options={containerClasses:""},Object.assign(this._options,t),this._prepareConfiguration(e.categories.slice()),this._config.uploadBkgsEnabled&&(this._uploader=new p({onSubmit:this._onCustomBkgAdded.bind(this),onHide:this._onUploaderClose.bind(this),getExampleText:this.getTextAsHtml.bind(this),getPostOwnerId:this._options.getPostOwnerId,placeholder:this._config.customLayerPlaceholder})),this._editorWidth=t.width,this._onChangeData=this._options.onChangeData,this._setFirstBkgByCategoryIdx(0,!0,!0),this._createEditor()}openEditor(){this.state.opened||(this.state.opened=!0,Object(n.isFunction)(this._options.onPreOpen)&&this._options.onPreOpen(),this._flags.isFirstLaunch&&(this._initEditor(),this._flags.isFirstLaunch=!1),this._setBackgroundUrl(this._els.activeBackgroundElem,this._activeBackground),this._loadNearBackgrounds(this._els.activePreviewEl),Object(i.show)(this._els.posterElem),domInsertBefore(this._els.inputMsg,Object(i.domFC)(this._els.posterView)),this._updateText(),this._autoscrollPreviews(!0),this._onChangeData&&this._onChangeData(),Object(n.isFunction)(this._options.onPostOpen)&&this._options.onPostOpen())}closeEditor(){this.state.opened&&(this.state.opened=!1,Object(n.isFunction)(this._options.onPreHide)&&this._options.onPreHide(),Object(i.hide)(this._els.posterElem),Object(i.re)(this._els.inputMsg),this._onChangeData&&this._onChangeData(),this._closeTooltip(this._els.closePosterBtn),Object(n.isFunction)(this._options.onPostHide)&&this._options.onPostHide())}isOpen(){return this.state.opened}isTextValid(e){var t=e.length,s=e.match(/\n/g),i=s?s.length:0;return t<=this._config.constants.max_symbols&&i<=3}isTextFieldValid(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._els.inputMsg;return this.isTextValid(this._getFormatString(e))}isCustomBkgId(e){return e&&0!=e.split("_")[0]}checkText(){this._onChangeText()}changeBtnText(e){this._els.sendBtn.innerHTML=e}focusPoster(){this._focusOnInput()}sendStatsInfo(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";(Object(n.isObject)(t)||isArray(t))&&(t=JSON.stringify(t)),ajax.post("al_page.php",{act:"poster_event",type:e,bkg_id:this._activeBackground.id,hash:this._config.eventHash,msg:t})}removeCustomBkg(e){if(this.isCustomBkgId(e)){var t=this._backgroundsMap[e],s=this._backgroundsMap[t.id].previewEl;this._nextBkg(!0),Object(i.re)(s),geByClass1("poster__new-bkg",this._els.newBkgBtn).innerHTML=Object(l.getLang)("wall_poster_upload_bkg_btn"),this._customBkg=null,delete this._backgroundsMap[e],delete this._categoriesMap[t.categoryId].bkgs[e]}}addCustomBkg(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.isCustomBkgId(e.id)){this._customBkg&&this.removeCustomBkg(this._customBkg.id),geByClass1("poster__new-bkg",this._els.newBkgBtn).innerHTML=Object(l.getLang)("wall_poster_change_upload_bkg_btn");var s=Object.keys(this._categoriesMap)[0];e.categoryId=s,this._categoriesMap[s].bkgs[e.id]=e,this._backgroundsMap[e.id]=e,this._customBkg=e;var r=this._els.sliderBody,o=this._getPreviewTemplate(e.id),n=Object(i.se)(o);e.previewEl=n,Object(i.addClass)(n,"poster__slider-item_custom"),r.insertBefore(n,r.firstChild),t&&this.setBkg(e.id,!0)}}_onCustomBkgAdded(e){this.addCustomBkg(e)}_onUploaderClose(){Object(n.isFunction)(this._options.onPostUploaderClose)&&this._options.onPostUploaderClose()}nextCategory(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=Object.keys(this._categoriesMap),s=t.indexOf(this._activeCategory.id);s<t.length-1?++s:s=0,this._setFirstBkgByCategoryIdx(s,e),this._onChangeData&&this._onChangeData()}resetPoster(){this._customBkg&&this.removeCustomBkg(this._customBkg.id),this._setFirstBkgByCategoryIdx(0,!0)}getPosterElement(){return this._els.posterElem}getPostOptionsWrapperEl(){return this._els.postOptionsWrapper}getErrorWrapperElement(){return this._els.submitErrorView}getTextInputEl(){return this._els.inputMsg}getText(){return this._text}getTextAsHtml(){return this._els.inputMsg.innerHTML}getBkgId(){return this._bkgId}getCustomBkg(){return this._customBkg}getBtnsWrapper(){return this._els.posterBtnsWrapper}setText(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?this._els.inputMsg.innerHTML=e:null!=this._els.inputMsg.innerText?this._els.inputMsg.innerText=e:this._els.inputMsg.textContent=e,this._text=this._getTextFromInput(),this._checkPlaceholder(!0)}setBkg(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e){var s=this._backgroundsMap[e];if(s){var r=this._backgroundsMap[e].previewEl,o=this.isCustomBkgId(this._activeBackground.id);this._setBkgInModel(s.id),Object(i.removeClass)(this._els.activePreviewEl,"poster__slider-item_active"),Object(i.addClass)(r,"poster__slider-item_active");var l=this._els.activeBackgroundElem,n=this._createBackgroundElem(s);this._els.posterImageContainer.appendChild(n),o&&this._toggleBkgAuthorEl(!1,t),this.isCustomBkgId(e)&&s.author_link&&(this.changeBkgAuthor({authorName:s.author_name,authorUrl:s.author_link},!0),this._toggleBkgAuthorEl(!0,t)),t?(Object(i.re)(l),Object(i.show)(n)):(Object(d.fadeOut)(l,250,()=>{Object(i.re)(l)}),Object(d.fadeIn)(n,250)),this._els.activePreviewEl=r,this._els.activeBackgroundElem=n,this._updateContent(t),this._loadNearBackgrounds(this._els.activePreviewEl),this._onChangeData&&this._onChangeData()}}}_setBkgInModel(e){this._activeBackground=this._backgroundsMap[e],this._activeCategory=this._categoriesMap[this._activeBackground.categoryId],this._bkgId=e}scrollPreviews(e,t){Object(r.cancelEvent)(e);var s=this._els.sliderBody;if(s.clientWidth!==s.scrollWidth){var i=t||(Math.abs(e.deltaY)>Math.abs(e.deltaX)?e.deltaY:e.deltaX);i<0||s.scrollLeft+s.clientWidth+i<s.scrollWidth?this._scrollLeft=Math.max(0,s.scrollLeft+i):this._scrollLeft=Math.max(0,s.scrollWidth-s.clientWidth),this._applyScroll(s,e,300)&&this._checkSliderSize()}}lockEditPoster(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Object(i.attr)(this._els.inputMsg,"contenteditable",!1),Object(i.show)(this._els.loadingWrapper),e&&Object(o.lockButton)(this._els.sendBtn)}unlockEditPoster(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Object(i.attr)(this._els.inputMsg,"contenteditable",!0),Object(i.hide)(this._els.loadingWrapper),e&&Object(o.unlockButton)(this._els.sendBtn)}destroy(){this._removeListeners(),Wall.deinitComposer(this._els.inputMsg),Object(i.re)(this._els.posterElem),Object(n.isFunction)(this._options.onDestroy)&&this._options.onDestroy()}_initEditor(){this._loadImgPreviews(),this._editorWidth||(this._editorWidth=this._options.appendToElem.clientWidth,this._textSizeIdx=null,this._setTextSettings())}_nextBkg(e){var t=this._els.activePreviewEl,s=Object(i.domNS)(t);s||(s=Object(i.domFC)(this._els.sliderBody));var r=Object(i.domData)(s,"bkg-id");return this.setBkg(r,e),this.sendStatsInfo("select_bkg"),!1}_prevBkg(){var e=this._els.activePreviewEl,t=Object(i.domPS)(e);t||(t=domLC(this._els.sliderBody));var s=Object(i.domData)(t,"bkg-id");return this.setBkg(s),this.sendStatsInfo("select_bkg"),!1}_createBtnsWrapper(){if(this._els.posterBtnsWrapper=Object(i.se)('<div class="poster__btns-wrapper" style="display: none"></div>'),this._config.uploadBkgsEnabled){var e=this._customBkg?Object(l.getLang)("wall_poster_change_upload_bkg_btn"):Object(l.getLang)("wall_poster_upload_bkg_btn");this._els.newBkgBtn=Object(i.se)(`\n        <div class="poster__new-bkg-btn-layout" id="poster-new-bkg-btn">\n          <div class="poster__new-bkg-btn-wrapper">\n            <span class="poster__new-bkg">${e}</span>\n          </div>\n        </div>\n      `),this._els.posterBtnsWrapper.appendChild(this._els.newBkgBtn)}}_autoscrollPreviews(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._backgroundsMap[this._activeBackground.id].previewEl,s=this._els.sliderBody,i=+getComputedStyle(t).marginLeft.slice(0,-2),r=t.clientWidth+2*i,o=vk.rtl?s.scrollWidth-s.clientWidth+t.offsetLeft:t.offsetLeft;this._scrollLeft+37<=o-i&&o+r-i<=this._scrollLeft+s.clientWidth-37?this._checkSliderSize():(this._scrollLeft=Math.max(0,o-i-s.clientWidth/2+r/2),this._applyScroll(s,e)&&this._checkSliderSize())}_applyScroll(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:600;if(t)e.scrollLeft=this._scrollLeft;else{if(0===this._scrollLeft||this._scrollLeft+e.clientWidth>=e.scrollWidth)return 0===this._scrollLeft?Object(i.removeClass)(this._els.sliderArrowRight,"poster__slider-arrow_disabled"):Object(i.removeClass)(this._els.sliderArrowLeft,"poster__slider-arrow_disabled"),Object(d.animate)(e,{scrollLeft:this._scrollLeft},s,this._checkSliderSize.bind(this)),!1;Object(d.animate)(e,{scrollLeft:this._scrollLeft},s)}return!0}_createPosterElem(){this._createPosterViewElem(),this._createAuthorInfoElem(),this._createBtnsWrapper(),this._createPosterErrorView(),this._createToolbarElem(),this._createLoadingWrapper(),this._els.posterElem=Object(i.se)(`<div class="poster poster-editor ${this._options.containerClasses}" style="display: none"></div>`),this._options.appendToElem.appendChild(this._els.posterElem),this._els.posterElem.classList.add("poster","poster-editor"),this._els.posterElem.appendChild(this._els.posterImageContainer),this._els.posterElem.appendChild(this._els.posterView),this._els.posterElem.appendChild(this._els.submitErrorView),this._els.posterElem.appendChild(this._els.posterBtnsWrapper),this._els.posterElem.appendChild(this._els.toolbarWrapper),this._els.posterElem.appendChild(this._els.loadingWrapper)}_createToolbarElem(){this._els.toolbarWrapper=Object(i.se)('<div class="poster__toolbar-wrapper"></div>'),this._els.toolbar=Object(i.se)('<div class="poster__toolbar"></div>'),this._els.closePosterBtn=Object(i.se)('<div class="poster__close-button"></div>'),this._createSliderElem(),this._createSidebarElem(),this._els.toolbar.appendChild(this._els.closePosterBtn),this._els.toolbar.appendChild(this._els.slider),this._els.toolbar.appendChild(this._els.sidebar),this._els.authorInfoElem&&this._els.toolbarWrapper.appendChild(this._els.authorInfoElem),this._els.toolbarWrapper.appendChild(this._els.toolbar)}_createSidebarElem(){this._els.sidebar=Object(i.se)('<div class="poster__sidebar"></div>'),this._els.sendBtnWrapper=Object(i.se)('<div class="poster__send-btn-wrapper"></div>'),this._els.sendBtn=Object(i.se)(`<button class="poster__send-btn flat_button addpost_button">${Object(l.getLang)("wall_send")}</button>`),this._els.sendBtnWrapper.appendChild(this._els.sendBtn),this._els.postOptionsWrapper=Object(i.se)('<div class="poster__settings-btn-wrapper"></div>'),this._els.sidebar.appendChild(this._els.postOptionsWrapper),Object(n.isFunction)(this._options.onCancelClick)&&(this._els.cancelBtnWrapper=Object(i.se)('<div class="poster__cancel-btn-wrapper _cancel-btn"></div>'),this._els.cancelBtn=Object(i.se)(`<div class="poster__cancel-btn flat_button wpe_cancel secondary button_light">${Object(l.getLang)("global_cancel")}</div>`),this._els.cancelBtnWrapper.appendChild(this._els.cancelBtn),this._els.sidebar.appendChild(this._els.cancelBtnWrapper)),this._els.sidebar.appendChild(this._els.sendBtnWrapper)}_createSliderElem(){this._els.slider=Object(i.se)('<div class="poster__slider"></div>'),this._els.sliderArrowLeft=Object(i.se)('<div class="poster__slider-arrow _left"></div>'),this._els.sliderBody=Object(i.se)('<div class="poster__slider-body"></div>'),this._els.sliderArrowRight=Object(i.se)('<div class="poster__slider-arrow _right"></div>'),this._createPreviews(),this._els.slider.appendChild(this._els.sliderArrowLeft),this._els.slider.appendChild(this._els.sliderBody),this._els.slider.appendChild(this._els.sliderArrowRight)}_createPosterViewElem(){this._els.posterView=Object(i.se)('<div class="poster__view"></div>'),this._els.posterImageContainer=Object(i.se)('<div class="poster__image-wrapper"></div>'),this._els.activeBackgroundElem=Object(i.se)(`<div class="poster__image" style="background-color: #${this._activeBackground.main_color}"></div>`),this._els.changeCategoryBtn=Object(i.se)(`<div class="poster__change-bkg-btn">${this._activeCategory.name}</div>`),this._els.posterImageContainer.appendChild(this._els.activeBackgroundElem),this._els.posterView.appendChild(this._els.changeCategoryBtn),this._createInputMsgElem(),this._els.posterView.appendChild(this._els.inputMsg),this._els.placeholder&&this._els.posterView.appendChild(this._els.placeholder),this._els.prevArrowWrapperBkg=Object(i.se)('\n      <div class="poster__bkg-arrow-wrapper poster__bkg-arrow_left">\n        <div class="poster__bkg-arrow-shadow"></div>\n      </div>'),this._els.prevArrowBkg=Object(i.se)('<div class="poster__bkg-arrow"></div>'),this._els.prevArrowWrapperBkg.appendChild(this._els.prevArrowBkg),this._els.nextArrowWrapperBkg=Object(i.se)('\n      <div class="poster__bkg-arrow-wrapper poster__bkg-arrow_right">\n        <div class="poster__bkg-arrow-shadow"></div>\n      </div>'),this._els.nextArrowBkg=Object(i.se)('<div class="poster__bkg-arrow"></div>'),this._els.nextArrowWrapperBkg.appendChild(this._els.nextArrowBkg),this._els.posterView.appendChild(this._els.prevArrowWrapperBkg),this._els.posterView.appendChild(this._els.nextArrowWrapperBkg);var e=this._activeBackground,t="#",s="",r="none";this.isCustomBkgId(e.id)&&e.author_link&&(t=e.author_link,s=e.author_name,r="block");var o=`<a href="${t}" class="poster__author-bkg" style="display: ${r};" onmouseover="mentionOver(this, { shift: [0, 10, 10] })" target="_blank">\n                    ${s}\n                  </a>`;this._els.bkgAuthorEl=Object(i.se)(o),this._els.posterView.appendChild(this._els.bkgAuthorEl)}_createInputMsgElem(){this._textSizeIdx=0,this._setTextSettings();var e="#"+this._activeBackground.text_color,t=this._options.prefixId?this._options.prefixId:"";this._els.inputMsg=Object(i.ce)("div",{id:t+"poster-field-msg",className:"poster__input-msg"},{fontSize:this._textSettings[this._textSizeIdx].fontSize,lineHeight:this._textSettings[this._textSizeIdx].lineHeight,color:e}),Object(i.attr)(this._els.inputMsg,"contenteditable",!0);var s=this._options.placeholder;s&&(this._els.placeholder=Object(i.se)(`<div class="poster__placeholder" style="color: ${e}">${s}</div>`))}_createAuthorInfoElem(){var e=this._options.authorInfoTemplate;e&&(this._els.authorInfoElem=Object(i.se)(`<div class="poster__author-info">${e}</div>`))}_createLoadingWrapper(){this._els.loadingWrapper=Object(i.se)('<div class="poster__loading-wrapper"></div>')}_createBackgroundElem(e){var t=this._getSizeImgIdx(e),s=Object(i.se)(`<div class="poster__image" style="display: none; background-color: #${e.main_color}"></div>`);return null!=t&&Object(i.setStyle)(s,{backgroundImage:`url(${e.urls.main[t].url})`}),s}_createPreviews(){var e=this._els.sliderBody;Object.keys(this._backgroundsMap).forEach(t=>{var s=this._getPreviewTemplate(t),r=Object(i.se)(s);this._backgroundsMap[t].previewEl=r,e.appendChild(r)}),this._els.activePreviewEl=geByClass1("poster__slider-item_active",e)}_closeTooltip(e){e&&e.tt&&Object(n.isFunction)(e.tt.hide)&&e.tt.hide()}_getPreviewTemplate(e){var t=this._backgroundsMap[e],s="";return s+="emoji"===t.categoryId?" poster__slider-item_emoji":"",s+=this._activeBackground.id===t.id?" poster__slider-item_active":"",`<div class="poster__slider-item${s+=this.isCustomBkgId(e)?" poster__slider-item_custom":""}" data-bkg-id="${t.id}" style="background-color: ${"#"+t.main_color}"></div>`}_getFormatString(e){if(null!=e.innerText){var t=e.innerText;return"\n"===t.substr(-1)?t.slice(0,-1):t}var s=window.getSelection(),i=null;s.rangeCount&&(i=s.getRangeAt(0));var r=document.createRange();r.selectNodeContents(e),s.removeAllRanges(),s.addRange(r);var o=s.toString();return s.removeAllRanges(),i&&s.addRange(i),o}_getTextSizeIdx(e){return e>this._config.constants.range_threshold?1:0}_getSizeImgIdx(e){if(!e||!e.urls)return null;for(var t=this._editorWidth*window.devicePixelRatio,s=0;s<e.urls.main.length;s++){if(e.urls.main[s].width<t)return e.urls.main[s-1]?s-1:s}return e.urls.main.length-1}_focusOnInput(e,t){t=t||this._els.inputMsg,setTimeout(()=>{window.wall.focusOnEnd(t)},0)}_checkSliderSize(){var e=this._els.sliderBody.scrollWidth,t=this._els.sliderBody.clientWidth,s=this._scrollLeft;if(t!==e){var r=Math.max(0,e-(t+s));0===s?Object(i.addClass)(this._els.sliderArrowLeft,"poster__slider-arrow_disabled"):Object(i.removeClass)(this._els.sliderArrowLeft,"poster__slider-arrow_disabled"),0===r?Object(i.addClass)(this._els.sliderArrowRight,"poster__slider-arrow_disabled"):Object(i.removeClass)(this._els.sliderArrowRight,"poster__slider-arrow_disabled")}}_checkPlaceholder(e){if(this._els.placeholder){var t=()=>{var e=this._els.inputMsg.textContent;e&&browser.opera&&e.match(/^[ ]+$/)&&(e=""),e||(e=Object(i.geByTag)("br",this._els.inputMsg).length>1),e?(Object(i.hide)(this._els.placeholder),Object(i.setStyle)(this._els.inputMsg,{paddingLeft:32,textAlign:"center"})):(Object(i.show)(this._els.placeholder),Object(i.setStyle)(this._els.inputMsg,{paddingLeft:this._els.placeholder.offsetLeft,textAlign:"left"}))};e?t():setTimeout(t,100)}}_loadNearBackgrounds(e){setTimeout(()=>{var t=Object(i.domPS)(e),s=Object(i.domNS)(e);t&&(this._loadBackgroundImageByPreview(t),t=Object(i.domPS)(t)),t&&this._loadBackgroundImageByPreview(t),s&&(this._loadBackgroundImageByPreview(s),s=Object(i.domNS)(s)),s&&this._loadBackgroundImageByPreview(s)},0)}_loadBackgroundImageByPreview(e){var t=Object(i.domData)(e,"bkg-id"),s=this._backgroundsMap[t],r=this._getSizeImgIdx(s);(new Image).src=s.urls.main[r].url}_onChangeText(e){var t=Object(n.isFunction)(this._options.onOverTextLimit);if(e&&"input"!=e.type||!t){if(e&&"keypress"==e.type&&!t){var s=e.which,i=String.fromCharCode(s);13==s&&(i="\n");var o=i+this._getTextFromInput();return!!this.isTextValid(o)||(Object(r.cancelEvent)(e),!1)}}else if(!this.isTextFieldValid())return void this._options.onOverTextLimit();this._updateText(),this._onChangeData&&this._onChangeData()}_getTextFromInput(){return this._getFormatString(this._els.inputMsg)}_updateTextSize(){var e=this._getTextFromInput(),t=this._getTextSizeIdx(e.length);t!==this._textSizeIdx&&(this._textSizeIdx=t,Object(i.setStyle)(this._els.inputMsg,{fontSize:this._textSettings[t].fontSize,lineHeight:this._textSettings[t].lineHeight}))}_createPosterErrorView(){this._els.submitErrorView=Object(i.se)('<div class="poster__submit-error"></div>')}_createLoadingWrapper(){this._els.loadingWrapper=Object(i.se)('<div class="poster__loading-wrapper"></div>')}_onPosterViewMouseenter(){Object(i.addClass)(this._els.posterView,"poster__view_hover")}_onNextCategoryBtnClick(){this.nextCategory(),this.sendStatsInfo("select_category")}_onPosterViewMouseout(e){0==e.screenX&&0==e.screenY||Object(i.removeClass)(this._els.posterView,"poster__view_hover")}_initListeners(){this._closePosterBtnClickHandler=this._onCloseBtnClick.bind(this),this._changeCategoryBtnClickHandler=this._onNextCategoryBtnClick.bind(this),this._sliderBodyWheelHandler=this.scrollPreviews.bind(this),this._sliderArrowRightClickHandler=this.scrollPreviews.bind(this,null,151),this._sliderArrowLeftClickHandler=this.scrollPreviews.bind(this,null,-151),this._posterViewClickHandler=this._onPosterViewClick.bind(this),this._sendBtnClickHandler=this._send.bind(this),this._inputMsgInputHandler=this._onChangeText.bind(this),this._hotKeyKeydownHandler=this._hotKeyHandler.bind(this),this._inputMsgPasteHandler=this._onPasteText.bind(this),this._inputMsgMouseHandler=this._checkMouseSelection.bind(this),this._inputMsgKeypressHandler=this._onChangeText.bind(this),Object(n.isFunction)(this._options.onOverTextLimit)||Object(r.addEvent)(this._els.inputMsg,"keypress",this._inputMsgKeypressHandler),this._inputMsgPlaceholderFocus=this._checkPlaceholder.bind(this),this._inputMsgPlaceholderBlur=this._checkPlaceholder.bind(this),this._inputMsgPlaceholderInput=this._checkPlaceholder.bind(this),this._nextBkgBtnClickHandler=vk.rtl?this._prevBkg.bind(this,!1):this._nextBkg.bind(this,!1),this._prevBkgBtnClickHandler=vk.rtl?this._nextBkg.bind(this,!1):this._prevBkg.bind(this,!1),this._posterViewMouseenterHandler=this._onPosterViewMouseenter.bind(this),this._posterViewMouseleaveHandler=this._onPosterViewMouseout.bind(this),this._arrowBkgMouseenterHandler=this._toggleBkgArrowHover.bind(this,!0),this._arrowBkgMouseleaveHandler=this._toggleBkgArrowHover.bind(this,!1),this._sliderClickHandler=this._onPreviewItemClick.bind(this),this._sliderMousedownHandler=this._saveFocus.bind(this);var e=_.showTooltip.bind(this._els.closePosterBtn,this._els.closePosterBtn,{text:Object(l.getLang)("wall_poster_close"),black:1,shift:[5,-10]});this._closePosterBtnMouseoverHandler=e,Object(r.addEvent)(this._els.posterView,"mouseenter",this._posterViewMouseenterHandler),Object(r.addEvent)(this._els.posterView,"mouseleave",this._posterViewMouseleaveHandler),Object(r.addEvent)(this._els.nextArrowWrapperBkg,"mouseenter",this._arrowBkgMouseenterHandler),Object(r.addEvent)(this._els.prevArrowWrapperBkg,"mouseenter",this._arrowBkgMouseenterHandler),Object(r.addEvent)(this._els.nextArrowWrapperBkg,"mouseleave",this._arrowBkgMouseleaveHandler),Object(r.addEvent)(this._els.prevArrowWrapperBkg,"mouseleave",this._arrowBkgMouseleaveHandler),Object(r.addEvent)(this._els.nextArrowWrapperBkg,"mousedown",this._nextBkgBtnClickHandler),Object(r.addEvent)(this._els.prevArrowWrapperBkg,"mousedown",this._prevBkgBtnClickHandler),Object(r.addEvent)(this._els.closePosterBtn,"click",this._closePosterBtnClickHandler),Object(r.addEvent)(this._els.closePosterBtn,"mouseover",this._closePosterBtnMouseoverHandler),Object(r.addEvent)(this._els.changeCategoryBtn,"mousedown",this._changeCategoryBtnClickHandler),Object(r.addEvent)(this._els.sliderBody,browserFeatures.wheelEvent,this._sliderBodyWheelHandler),Object(r.addEvent)(this._els.sliderBody,"click",this._sliderClickHandler),Object(r.addEvent)(this._els.sliderBody,"mousedown",this._sliderMousedownHandler),Object(r.addEvent)(this._els.sliderArrowRight,"click",this._sliderArrowRightClickHandler),Object(r.addEvent)(this._els.sliderArrowLeft,"click",this._sliderArrowLeftClickHandler),Object(r.addEvent)(this._els.posterView,"click",this._posterViewClickHandler),Object(r.addEvent)(this._els.inputMsg,"input",this._inputMsgInputHandler),Object(r.addEvent)(this._els.inputMsg,"keydown",this._hotKeyKeydownHandler),Object(r.addEvent)(this._els.inputMsg,"paste",this._inputMsgPasteHandler),Object(r.addEvent)(this._els.inputMsg,"mousedown mouseup",this._inputMsgMouseHandler),Object(r.addEvent)(this._els.closePosterBtn,"mousedown",this._saveFocus.bind(this)),Object(r.addEvent)(this._els.changeCategoryBtn,"mousedown",this._saveFocus.bind(this)),Object(r.addEvent)(this._els.sliderArrowRight,"mousedown",this._saveFocus.bind(this)),Object(r.addEvent)(this._els.sliderArrowLeft,"mousedown",this._saveFocus.bind(this)),Object(r.addEvent)(this._els.sidebar,"mousedown",this._saveFocus.bind(this)),Object(r.addEvent)(this._els.sendBtn,"click",this._sendBtnClickHandler),this._config.uploadBkgsEnabled&&Object(r.addEvent)(this._els.newBkgBtn,"click",this._openUploader.bind(this)),Object(n.isFunction)(this._options.onCancelClick)&&Object(r.addEvent)(this._els.cancelBtn,"click",this._options.onCancelClick),this._els.placeholder&&(Object(r.addEvent)(this._els.inputMsg,"focus",this._inputMsgPlaceholderFocus),Object(r.addEvent)(this._els.inputMsg,"input",this._inputMsgPlaceholderInput),Object(r.addEvent)(this._els.inputMsg,"blur",this._inputMsgPlaceholderBlur))}_removeListeners(){Object(r.removeEvent)(this._els.posterView,"mouseenter",this._posterViewMouseenterHandler),Object(r.removeEvent)(this._els.posterView,"mouseleave",this._posterViewMouseleaveHandler),Object(r.removeEvent)(this._els.nextArrowWrapperBkg,"mousedown",this._nextBkgBtnClickHandler),Object(r.removeEvent)(this._els.prevArrowWrapperBkg,"mousedown",this._prevBkgBtnClickHandler),Object(r.removeEvent)(this._els.nextArrowWrapperBkg,"mouseenter",this._arrowBkgMouseenterHandler),Object(r.removeEvent)(this._els.prevArrowWrapperBkg,"mouseenter",this._arrowBkgMouseenterHandler),Object(r.removeEvent)(this._els.nextArrowWrapperBkg,"mouseleave",this._arrowBkgMouseenterHandler),Object(r.removeEvent)(this._els.prevArrowWrapperBkg,"mouseleave",this._arrowBkgMouseleaveHandler),Object(r.removeEvent)(this._els.closePosterBtn,"click",this._closePosterBtnClickHandler),Object(r.removeEvent)(this._els.closePosterBtn,"mouseover",this._closePosterBtnMouseoverHandler),Object(r.removeEvent)(this._els.changeCategoryBtn,"mousedown",this._changeCategoryBtnClickHandler),Object(r.removeEvent)(this._els.sliderBody,"wheel",this._sliderBodyWheelHandler),Object(r.removeEvent)(this._els.sliderBody,"click",this._sliderClickHandler),Object(r.removeEvent)(this._els.sliderBody,"mousedown",this._sliderMousedownHandler),Object(r.removeEvent)(this._els.sliderArrowRight,"click",this._sliderArrowRightClickHandler),Object(r.removeEvent)(this._els.sliderArrowLeft,"click",this._sliderArrowLeftClickHandler),Object(r.removeEvent)(this._els.posterView,"click",this._posterViewClickHandler),Object(r.removeEvent)(this._els.sendBtn,"click",this._sendBtnClickHandler),Object(r.removeEvent)(this._els.inputMsg,"input keydown",this._inputMsgInputHandler),Object(r.removeEvent)(this._els.inputMsg,"paste",this._inputMsgPasteHandler),Object(r.removeEvent)(this._els.inputMsg,"mousedown mouseup",this._inputMsgMouseHandler),Object(n.isFunction)(this._options.onOverTextLimit)||Object(r.removeEvent)(this._els.inputMsg,"keypress",this._inputMsgKeypressHandler),Object(r.removeEvent)(this._els.closePosterBtn,"mousedown",this._saveFocus.bind(this)),Object(r.removeEvent)(this._els.changeCategoryBtn,"mousedown",this._saveFocus.bind(this)),Object(r.removeEvent)(this._els.sliderArrowRight,"mousedown",this._saveFocus.bind(this)),Object(r.removeEvent)(this._els.sliderArrowLeft,"mousedown",this._saveFocus.bind(this)),Object(r.removeEvent)(this._els.sidebar,"mousedown",this._saveFocus.bind(this)),this._config.uploadBkgsEnabled&&Object(r.removeEvent)(this._els.newBkgBtn,"click",this._openUploader.bind(this)),Object(n.isFunction)(this._options.onCancelClick)&&Object(r.removeEvent)(this._els.cancelBtn,"click",this._options.onCancelClick),this._els.placeholder&&(Object(r.removeEvent)(this._els.inputMsg,"focus",this._inputMsgPlaceholderFocus),Object(r.removeEvent)(this._els.inputMsg,"input",this._inputMsgPlaceholderInput),Object(r.removeEvent)(this._els.inputMsg,"blur",this._inputMsgPlaceholderBlur))}_openUploader(){this._uploader&&(Object(n.isFunction)(this._options.onPreUploaderOpen)&&this._options.onPreUploaderOpen(),this._uploader.show())}_onPosterViewClick(e){e.target==e.currentTarget&&this._focusOnInput()}_checkMouseSelection(e){"mousedown"==e.type?(Object(i.setStyle)(this._els.nextArrowWrapperBkg,{pointerEvents:"none"}),Object(i.setStyle)(this._els.prevArrowWrapperBkg,{pointerEvents:"none"})):"mouseup"==e.type&&(Object(i.setStyle)(this._els.nextArrowWrapperBkg,{pointerEvents:"auto"}),Object(i.setStyle)(this._els.prevArrowWrapperBkg,{pointerEvents:"auto"}))}_createEditor(){this._createPosterElem(),this._initListeners(),cur.destroy.push(this.destroy.bind(this)),Wall.initComposer(this._els.inputMsg,{lang:{introText:Object(l.getLang)("profile_mention_start_typing"),noResult:Object(l.getLang)("profile_mention_not_found")},appendTo:this._insertComposer.bind(this),poster:this})}_updateContent(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t="#"+this._activeBackground.text_color,s=this._activeCategory.name;this._els.changeCategoryBtn.innerHTML!==s&&(this._els.changeCategoryBtn.innerHTML=s),Object(i.setStyle)(this._els.inputMsg,{color:t}),Object(i.setStyle)(this._els.placeholder,{color:t}),this._onChangeText(),this._autoscrollPreviews(e)}_insertComposer(e){e&&window.domInsertAfter(e,this._els.posterView)}_loadImgPreviews(){for(var e=this._els.sliderBody.children,t=/.([a-z-]{3,5})((\?.*)?$)/,s=window.devicePixelRatio,r=0;r<e.length;r++){var o=e[r],l=Object(i.domData)(o,"bkg-id"),n=this._backgroundsMap[l],a=s>1&&n.preview?n.preview.replace(t,"_2x.$1$2"):n.preview,h=n.preview?"background":"backgroundColor";o.style[h]=n.preview?`url('${a}') no-repeat 50% / cover`:"#"+n.main_color}}_onPreviewItemClick(e){if(!Object(i.hasClass)(e.target,"poster__slider-item"))return!1;var t=e.target,s=Object(i.domData)(t,"bkg-id");if(this._activeBackground.id===s)return!1;this.setBkg(s),this.sendStatsInfo("select_bkg"),this._onChangeData&&this._onChangeData()}_onCloseBtnClick(e){this.sendStatsInfo("close"),this.closeEditor(e),Object(r.cancelEvent)(e)}_onPasteText(e){var t=Emoji.getClipboard(e),s=t+this._getTextFromInput();if(!this.isTextValid(s)&&!Object(n.isFunction)(this._options.onOverTextLimit))return Object(r.cancelEvent)(e),!1;t=t.replace(/\n/g,"<br/>");var o=Object(i.ce)("div",{innerHTML:t});Emoji.insertHTML(o.innerHTML),e&&this._onChangeData&&this._onChangeData(),Object(r.cancelEvent)(e)}_hotKeyHandler(e){if(!this.state.opened||this.state.toggled)return!1;e.ctrlKey&&e.keyCode==KEY.ENTER&&this._send(),e.ctrlKey||e.keyCode!=KEY.ESC||this._onCloseBtnClick(e)}_send(){var e=this._bkgId,t=Object(a.trim)(this._text),s=encodeURIComponent(t),i=this._backgroundsMap[e].access_hash;if(t.length&&!Object(o.isButtonLocked)(this._els.sendBtn)){if(this.lockEditPoster(),this._config.uploadGen){var r=this,l=this._config.uploadGen+"&bkg_access_hash="+i+"&text="+s+"&bkg_id="+e+"&ajx=1",n=new XMLHttpRequest,d=1e3*this._config.constants.upload_gen_timeout||4e3,_=!1;n.open("POST",l,!0);n.onreadystatechange=function(){if(4==this.readyState&&!_){var s,o=null,n=Object(h.parseJSON)(this.responseText);200===this.status&&((s=n)&&s.owner_id&&s.id&&s.post_hash)?o=n:r.sendStatsInfo("upload_failed",extend(n||{},{status:this.status,statusText:this.statusText,responseText:n?"":this.responseText,urlUploadFail:l})),r._options.onSend({text:t,bkgId:e,fallbackObj:o,accessHash:i}),clearTimeout(c)}};var c=setTimeout((function(){r.sendStatsInfo("upload_timeout"),r._options.onSend({text:t,bkgId:e,accessHash:i}),_=!0,n.abort()}),d);n.send()}else this._options.onSend({text:t,bkgId:e,accessHash:i});return!0}}_setFirstBkgByCategoryIdx(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=Object.keys(this._categoriesMap)[e],r=this._categoriesMap[i],o=this._customBkg&&0===e?this._customBkg.id:Object.keys(r.bkgs)[0];s?this._setBkgInModel(o):this.setBkg(o,t)}_setBackgroundUrl(e,t){var s=this._getSizeImgIdx(t);null!=s&&Object(i.setStyle)(e,{backgroundImage:`url(${this._activeBackground.urls.main[s].url})`})}_setTextSettings(){this._textSettings=[{fontSize:Math.round(this._config.constants.font_size_ratio_range_1*this._editorWidth)+"px",lineHeight:Math.round(this._config.constants.line_height_ratio_range_1*this._editorWidth)+"px"},{fontSize:Math.round(this._config.constants.font_size_ratio_range_2*this._editorWidth)+"px",lineHeight:Math.round(this._config.constants.line_height_ratio_range_2*this._editorWidth)+"px"}]}_saveFocus(){var e=geByClass1("post_action_btn_layout",this._els.postAvailableBtn),t=geByClass1("post_action_btn_layout",this._els.postponeBtn);e&&Object(i.data)(e,"ett").hide();t&&Object(i.data)(t,"ett").hide();return!1}_updateText(){this._text=this._getTextFromInput(),this._checkPlaceholder(),this._updateTextSize()}_toggleBkgArrowHover(e,t){if(0!=t.screenX||0!=t.screenY){var s=t.currentTarget;Object(i.hasClass)(s,"poster__bkg-arrow_right")?(toggleClass(this._els.nextArrowWrapperBkg,"poster__bkg-arrow_hovered",e),toggleClass(this._els.prevArrowWrapperBkg,"poster__bkg-arrow_faded",e)):Object(i.hasClass)(s,"poster__bkg-arrow_left")&&(toggleClass(this._els.prevArrowWrapperBkg,"poster__bkg-arrow_hovered",e),toggleClass(this._els.nextArrowWrapperBkg,"poster__bkg-arrow_faded",e))}}_toggleBkgAuthorEl(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e?t?Object(i.show)(this._els.bkgAuthorEl):Object(d.fadeIn)(this._els.bkgAuthorEl,250,()=>{Object(n.isFunction)(s)&&s()}):t?Object(i.hide)(this._els.bkgAuthorEl):Object(d.fadeOut)(this._els.bkgAuthorEl,250,()=>{Object(n.isFunction)(s)&&s()})}changeBkgAuthor(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.authorUrl&&e.authorName&&this._customBkg){this._activeBackground!==this._customBkg&&(t=!0);var s=()=>{this._els.bkgAuthorEl.href=e.authorUrl,this._els.bkgAuthorEl.innerHTML=Object(l.getLang)("wall_poster_author_custom_bkg").replace("{author_name}",e.authorName),Object(i.attr)(this._els.bkgAuthorEl,"mention_id",e.authorUrl.substr(1)),t||this._toggleBkgAuthorEl(),this._els.bkgAuthorEl.tt&&Object(n.isFunction)(this._els.bkgAuthorEl.tt.destroy)&&this._els.bkgAuthorEl.tt.destroy()};t?s():this._toggleBkgAuthorEl(!1,!1,s),this._customBkg.author_link=e.authorUrl,this._customBkg.author_name=e.authorName,this._onChangeData&&this._onChangeData()}}_prepareConfiguration(e){e.forEach(e=>{var t={};e.bkgs.forEach(s=>{t[s.id]=s,t[s.id].categoryId=e.id,this.isCustomBkgId(s.id)&&(this._customBkg=s)}),this._categoriesMap[e.id]=e,this._categoriesMap[e.id].bkgs=t,Object.assign(this._backgroundsMap,t)})}};window.Poster=g;try{stManager.done(jsc("web/poster.js"))}catch(e){}}});